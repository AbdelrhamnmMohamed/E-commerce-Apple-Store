<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add / Edit Product</title>

  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <link rel="stylesheet" href="../main.css" />
</head>
<body>

  <!-- side bar -->
  <aside id="sidebar" class="sidebar">
    <h3>
      <a href="../../index.html" class="text-white text-decoration-none">
        <i class="fa-brands fa-apple"></i> <br />Premium
      </a>
    </h3>
    <ul class="text-center">
      <li><a href="../dash/dash.html"><i class="fa fa-home"></i> Dashboard</a></li>
      <li><a href="index.html" class="active"><i class="fa fa-box"></i> Products</a></li>
      <li><a href="../customers/customer.html"><i class="fa fa-users"></i> Customers</a></li>
      <li><a href="../order/order.html"><i class="fa fa-shopping-cart"></i> Orders</a></li>
      <li><a href="../payment/payment.html"><i class="fa-solid fa-credit-card"></i> Payments</a></li>
      <li><a href="../seller/seller.html"><i class="fa-solid fa-truck-fast"></i> Sellers</a></li>
      <li><a href="../service/service.html"><i class="fa-solid fa-headset"></i> Customer Service</a></li>
    </ul>
  </aside>

<!--main content  -->
  <main id="mainContent" class="main-content">
    
    <nav class="navbar navbar-custom navbar-light mb-4">
      <div class="container-fluid d-flex align-items-center justify-content-between">
        <button class="btn btn-outline-secondary" id="toggleSidebarBtn">
          <i id="toggleIcon" class="fa fa-bars"></i>
        </button>
        <span class="navbar-brand mb-0 h1 text-center" id="formTitle">Add New Product</span>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="card shadow-sm p-4">
        <form id="productForm">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" id="name" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Category</label>
            <input type="text" class="form-control" id="category" required />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantity" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Price ($)</label>
            <input type="number" step="0.01" class="form-control" id="price" required />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Product Image (Optional)</label>
          <input type="file" class="form-control" id="imageFile" accept="image/*" />
          <small class="text-muted">
            <strong>‚ö†Ô∏è Max size: 50KB</strong> - Use small icons or leave empty to use default icon.
            <br>üí° Tip: Large images cause storage quota errors!
          </small>
          <div id="imagePreview" class="mt-3 text-center" style="display: none;">
            <p class="text-success"><strong>‚úÖ Image Uploaded</strong></p>
            <img id="previewImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border: 2px solid #ddd; border-radius: 8px; padding: 5px;">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Status</label>
          <select class="form-select" id="status">
            <option value="Active">Active</option>
            <option value="Pending">Pending</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>

        <hr class="my-4">
        <h5 class="mb-3">Product Details (Optional)</h5>

        <div class="mb-3">
          <label class="form-label">Overview</label>
          <textarea class="form-control" id="overview" rows="3" placeholder="Product description"></textarea>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Storage Options</label>
            <input type="text" class="form-control" id="storage" placeholder="e.g., 128GB, 256GB, 512GB" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Display</label>
            <input type="text" class="form-control" id="display" placeholder="e.g., 6.1-inch OLED, 120Hz" />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Camera</label>
          <input type="text" class="form-control" id="camera" placeholder="e.g., 48MP Main, 12MP Ultra-Wide" />
        </div>

        <div class="mb-3">
          <label class="form-label">Available Colors</label>
          <p class="text-muted small">Select the colors available for this product:</p>
          <div id="colorPicker" class="d-flex flex-wrap gap-3">
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Black|#000000">
              <span class="color-swatch" style="background-color: #000000;"></span>
              <span class="color-label">Black</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="White|#ffffff">
              <span class="color-swatch" style="background-color: #ffffff; border: 2px solid #ddd;"></span>
              <span class="color-label">White</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Blue|#1e40af">
              <span class="color-swatch" style="background-color: #1e40af;"></span>
              <span class="color-label">Blue</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Red|#dc2626">
              <span class="color-swatch" style="background-color: #dc2626;"></span>
              <span class="color-label">Red</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Green|#059669">
              <span class="color-swatch" style="background-color: #059669;"></span>
              <span class="color-label">Green</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Gold|#f59e0b">
              <span class="color-swatch" style="background-color: #f59e0b;"></span>
              <span class="color-label">Gold</span>
            </label>
            <label class="color-option">
              <input type="checkbox" name="productColor" value="Purple|#7c3aed">
              <span class="color-swatch" style="background-color: #7c3aed;"></span>
              <span class="color-label">Purple</span>
            </label>
          </div>
        </div>
        
        <style>
          .color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s;
          }
          .color-option:hover {
            background-color: #f3f4f6;
          }
          .color-option input[type="checkbox"] {
            display: none;
          }
          .color-option input[type="checkbox"]:checked + .color-swatch {
            border: 3px solid #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
          }
          .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 5px;
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
          }
          .color-label {
            font-size: 12px;
            font-weight: 500;
            margin-top: 5px;
          }
        </style>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary btn-lg flex-fill">
            <i class="fa fa-save"></i> Save Product
          </button>
          <button type="button" class="btn btn-secondary btn-lg" id="backBtn">
            <i class="fa fa-arrow-left"></i> Back to Products
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

  <script type="module" src="../dash.js"></script>
  <script>
    const form = document.getElementById("productForm");
    const backBtn = document.getElementById("backBtn");
    const title = document.getElementById("formTitle");
    const imageFileInput = document.getElementById("imageFile");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    
    let uploadedImageData = null;

    // Handle image upload
    imageFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        // Check file size (max 50KB to prevent storage issues!)
        if (file.size > 50 * 1024) {
          alert("‚ùå Image too large! Please use an image smaller than 50KB.\n\nüí° Tip: Use a small icon or leave empty to use default icon.\nThis prevents storage quota errors.");
          imageFileInput.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
          uploadedImageData = event.target.result;
          previewImg.src = uploadedImageData;
          imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // get edit ID from URL
    const params = new URLSearchParams(window.location.search);
    const editId = params.get("edit");

    // if editing, fill the form with product data
    if (editId !== null) {
      title.textContent = "Edit Product";
      const products = JSON.parse(localStorage.getItem("allProducts")) || [];
      const product = products.find(p => p.id === editId);

      if (product) {
        document.getElementById("name").value = product.name;
        document.getElementById("category").value = product.category;
        document.getElementById("quantity").value = product.quantity;
        document.getElementById("price").value = product.price;
        document.getElementById("status").value = product.status;
        
        // Load product details
        if (product.overview) document.getElementById("overview").value = product.overview;
        if (product.storage) document.getElementById("storage").value = product.storage;
        if (product.display) document.getElementById("display").value = product.display;
        if (product.camera) document.getElementById("camera").value = product.camera;
        
        // Select the colors that were previously chosen
        if (product.colors) {
          try {
            const savedColors = JSON.parse(product.colors);
            savedColors.forEach(colorData => {
              const checkbox = document.querySelector(`input[name="productColor"][value="${colorData.name}|${colorData.hex}"]`);
              if (checkbox) checkbox.checked = true;
            });
          } catch (e) {
            // If colors is just a string, ignore
          }
        }
        
        // Show existing image
        if (product.image) {
          uploadedImageData = product.image;
          previewImg.src = product.image;
          imagePreview.style.display = "block";
        }
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      
      // Use uploaded image or default image
      const finalImage = uploadedImageData || "imgs/store.png";

      const products = JSON.parse(localStorage.getItem("allProducts")) || [];

      // Get selected colors
      const selectedColors = [];
      document.querySelectorAll('input[name="productColor"]:checked').forEach(checkbox => {
        const [name, hex] = checkbox.value.split('|');
        selectedColors.push({ name, hex });
      });

      const productData = {
        name: document.getElementById("name").value,
        category: document.getElementById("category").value,
        quantity: parseInt(document.getElementById("quantity").value),
        price: parseFloat(document.getElementById("price").value),
        image: finalImage,
        status: document.getElementById("status").value,
        createdAt: new Date().toISOString().split("T")[0],
        overview: document.getElementById("overview").value.trim(),
        storage: document.getElementById("storage").value.trim(),
        display: document.getElementById("display").value.trim(),
        camera: document.getElementById("camera").value.trim(),
        colors: JSON.stringify(selectedColors)
      };

      if (editId !== null) {
        // update existing
        const index = products.findIndex(p => p.id === editId);
        if (index !== -1) {
          products[index] = { ...products[index], ...productData };
          alert("‚úÖ Product Updated Successfully!");
        }
      } else {
        // add new - generate unique ID
        productData.id = "product-" + Date.now();
        products.push(productData);
        alert("‚úÖ Product Added Successfully!");
      }

      localStorage.setItem("allProducts", JSON.stringify(products));
      window.location.href = "index.html";
    });

    backBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
