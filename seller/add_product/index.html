<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Products Dashboard</title>

    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    
    <link rel="stylesheet" href="../main.css" />
  </head>
  <body>
    
    <aside id="sidebar" class="sidebar">
      <h3>
        <a href="../../index.html" class="text-white text-decoration-none"
          ><i class="fa-brands fa-apple"></i> <br />Premium</a
        >
      </h3>
      <ul class="text-center">
        <li>
          <a href="../dash/dash.html"><i class="fa fa-home"></i>Dashboard</a>
        </li>
        <li>
          <a href="../add_product/index.html"
            ><i class="fa fa-box"></i> Products</a
          >
        </li>
        <li>
          <a href="../order/order.html"><i class="fa fa-users"></i> Orders</a>
        </li>
        <li>
          <a href="../porfile/prof.html"
            ><i class="fa-solid fa-user-tie"></i> Profile</a
          >
        </li>
      </ul>
    </aside>

    
    <main id="mainContent" class="main-content">
      
      <nav class="navbar navbar-custom navbar-light mb-4">
        <div
          class="container-fluid d-flex align-items-center justify-content-between"
        >
          <button class="btn btn-outline-secondary" id="toggleSidebarBtn">
            <i id="toggleIcon" class="fa fa-bars"></i>
          </button>
          <span class="navbar-brand mb-0 h1 text-center">Products Panel</span>
        </div>
      </nav>
      
      <section class="add">
        <div
          class="head d-flex justify-content-between align-items-center flex-wrap"
        >
          <h2>Products</h2>
          <form
            id="searchForm"
            class="d-flex justify-content-between align-items-center m-3 flex-start"
            role="search"
          >
            <input
              id="searchInput"
              class="form-control me-2 m-1"
              type="search"
              placeholder="Search about Product"
              aria-label="Search"
            />
            <button class="btn btn-outline-dark m-1" type="submit">
              Search
            </button>
            <button class="btn btn-primary m-1" type="button" id="addProduct">
              + Add
            </button>
          </form>
        </div>
        
        <div class="table-responsive mt-3 shadow-sm rounded">
          <table
            class="table table-striped align-middle table-bordered"
            id="productTable"
          >
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Image</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    
    <script type="module" src="../dash.js"></script>
    <script>
      // Get current user
      function getCurrentUser() {
        try {
          return JSON.parse(localStorage.getItem("currentUser")) || null;
        } catch {
          return null;
        }
      }

      const currentUser = getCurrentUser();
      const tableBody = document.querySelector("#productTable tbody");

      // Check if seller
      if (!currentUser || currentUser.role !== 'seller') {
        alert('You must be logged in as a seller!');
        window.location.href = '../../login/login.html';
      }

      // Load products from allProducts
      function loadProducts() {
        const allProducts = JSON.parse(localStorage.getItem("allProducts")) || [];
        
        console.log('Seller ID:', currentUser.id);
        console.log('All Products:', allProducts);
        console.log('Products with my sellerId:', allProducts.filter(p => p.sellerId === currentUser.id));
        
        // SHOW ONLY THIS SELLER'S PRODUCTS
        const myProducts = allProducts.filter(p => p.sellerId === currentUser.id);
        
        tableBody.innerHTML = "";

        if (myProducts.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-5">
                <i class="fa fa-box-open fa-3x mb-3 d-block text-muted"></i>
                <h5>No Products Yet</h5>
                <p>Click "+ Add" to add your first product</p>
              </td>
            </tr>
          `;
          return;
        }

        myProducts.forEach((product, index) => {
          // Fix image path
          let img = product.image;
          if (img && !img.startsWith('data:') && !img.startsWith('http') && !img.startsWith('../../')) {
            img = '../../' + img;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${index + 1}</td>
          <td>
            <img src="${img}" alt="${product.name}" 
                 style="width: 50px; height: 50px; object-fit: contain; background: #f8f9fa; padding: 5px; border-radius: 5px;" 
                 onerror="this.src='../../imgs/store.png'">
          </td>
          <td>${product.name}</td>
          <td><span class="badge bg-info">${product.category}</span></td>
          <td><strong>$${product.price}</strong></td>
          <td>${product.quantity}</td>
          <td><span class="badge ${
            product.status === "Active" ? "bg-success" :
            product.status === "Pending" ? "bg-warning text-dark" : "bg-secondary"
          }">${product.status}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-success edit" data-id="${product.id}" ${product.status === 'Active' ? 'disabled title="Approved products cannot be edited"' : ''}>
              <i class="fa fa-edit"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger delete" data-id="${product.id}">
              <i class="fa fa-trash"></i> Delete
            </button>
          </td>
        `;
          tableBody.appendChild(row);
        });

        attachEvents();
      }

      function attachEvents() {
        // Delete
        document.querySelectorAll(".delete").forEach((btn) => {
          btn.onclick = () => {
            if (!confirm('Delete this product?')) return;
            const id = btn.dataset.id;
            const allProducts = JSON.parse(localStorage.getItem("allProducts")) || [];
            const filtered = allProducts.filter(p => p.id !== id);
            localStorage.setItem("allProducts", JSON.stringify(filtered));
            loadProducts();
            alert('Product deleted!');
          };
        });

        // Edit
        document.querySelectorAll(".edit").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            window.location.href = `add-product.html?edit=${id}`;
          };
        });
      }

      // Search
      document.getElementById("searchForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const term = document.getElementById("searchInput").value.toLowerCase();
        const rows = tableBody.getElementsByTagName("tr");
        Array.from(rows).forEach((row) => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(term) ? "" : "none";
        });
      });

      // Add button
      document.getElementById("addProduct").addEventListener("click", () => {
        window.location.href = "add-product.html";
      });

      // Load on start
      loadProducts();
    </script>
  </body>
</html>
